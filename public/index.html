<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>zero-auth</title>
    <style>
      :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      body { 
        margin: 0; 
        min-height: 100vh;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 2rem;
      }
      h1 { margin-top: 0; }
      code { background: rgba(255,255,255,0.2); padding: .2rem .35rem; border-radius: 4px; }
      button { 
        padding: .6rem 1.2rem; 
        border-radius: 8px; 
        border: 2px solid currentColor; 
        background: rgba(255,255,255,0.1);
        color: inherit;
        cursor: pointer; 
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      button:hover { 
        background: rgba(255,255,255,0.2); 
        transform: translateY(-2px);
      }
      .row { margin: 1.5rem 0; }
      .muted { opacity: 0.8; font-size: .9rem; }
      .name-display {
        font-size: 2rem;
        font-weight: bold;
        margin: 1rem 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      }
      .loading { opacity: 0.6; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>zero-auth</h1>
      <p>You are recognized as:</p>
      <div class="row">
        <div class="name-display" id="nameDisplay">(loadingâ€¦)</div>
        <code id="uid" class="muted"></code>
      </div>
      <div class="row">
        <button id="reset">Reset identity</button>
      </div>
      <p class="muted">Same browser profile = same identity. Clearing site data resets it.</p>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, doc, getDoc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      
      // Try to import Firebase config, fallback to inline or window config
      let firebaseConfig;
      try {
        const configModule = await import('./firebase-config.js');
        firebaseConfig = configModule.firebaseConfig;
        
        // Check if config is still using placeholders
        if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE" || firebaseConfig.apiKey.includes("YOUR_")) {
          throw new Error('Config not set');
        }
      } catch (e) {
        // Fallback: use window.firebaseConfig if set
        if (window.firebaseConfig && window.firebaseConfig.apiKey && !window.firebaseConfig.apiKey.includes("YOUR_")) {
          firebaseConfig = window.firebaseConfig;
        } else {
          // Show error message since config is required
          document.getElementById('nameDisplay').textContent = 'Firebase config required';
          document.getElementById('uid').textContent = 'Please configure Firebase in firebase-config.js';
          throw new Error('Firebase configuration is required. Please update public/firebase-config.js with your Firebase web app config.');
        }
      }
      
      // Validate config
      if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
        throw new Error('Invalid Firebase configuration');
      }

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Generate deterministic user ID from localStorage
      function getOrCreateUserId() {
        let userId = localStorage.getItem('user_id');
        if (!userId) {
          userId = crypto.randomUUID();
          localStorage.setItem('user_id', userId);
        }
        return userId;
      }

      // Funny names list - 100 adjectives x 100 nouns = 10,000 combinations
      const adjectives = ['Vibe', 'Pickled', 'Cosmic', 'Spicy', 'Electric', 'Magical', 'Silly', 'Brave', 'Swift', 'Golden', 'Silver', 'Neon', 'Happy', 'Gigantic', 'Tiny', 'Wild', 'Calm', 'Bright', 'Shadow', 'Mystic', 'Crazy', 'Smooth', 'Bold', 'Gentle', 'Fierce', 'Fluffy', 'Radiant', 'Frozen', 'Burning', 'Sneaky', 'Wise', 'Jolly', 'Epic', 'Mighty', 'Cheerful', 'Dreamy', 'Sparkly', 'Quiet', 'Loud', 'Merry', 'Grumpy', 'Sleepy', 'Dopey', 'Bashful', 'Sneezy', 'Doc', 'Jumpy', 'Bouncy', 'Zippy', 'Snappy', 'Peppy', 'Lively', 'Energetic', 'Vibrant', 'Dynamic', 'Colorful', 'Vivid', 'Brilliant', 'Dazzling', 'Glowing', 'Shimmering', 'Glorious', 'Majestic', 'Regal', 'Noble', 'Proud', 'Confident', 'Fearless', 'Daring', 'Adventurous', 'Curious', 'Playful', 'Mischievous', 'Clever', 'Witty', 'Sharp', 'Quick', 'Agile', 'Nimble', 'Graceful', 'Elegant', 'Stylish', 'Chic', 'Trendy', 'Cool', 'Hip', 'Fresh', 'Modern', 'Classic', 'Vintage', 'Antique', 'Ancient', 'Legendary', 'Mythical', 'Mysterious', 'Enigmatic', 'Cryptic', 'Stealthy', 'Thunderous', 'Zesty'];
      const nouns = ['Genius', 'Teddy', 'Dragon', 'Panda', 'Wizard', 'Tiger', 'Phoenix', 'Unicorn', 'Fox', 'Shark', 'Eagle', 'Lion', 'Bear', 'Owl', 'Wolf', 'Falcon', 'Hawk', 'Deer', 'Rabbit', 'Turtle', 'Penguin', 'Dolphin', 'Whale', 'Elephant', 'Giraffe', 'Zebra', 'Monkey', 'Gorilla', 'Kangaroo', 'Koala', 'Sloth', 'Hedgehog', 'Squirrel', 'Raccoon', 'Badger', 'Beaver', 'Otter', 'Seal', 'Walrus', 'Polar Bear', 'Grizzly', 'Red Panda', 'Lemur', 'Chimp', 'Orangutan', 'Baboon', 'Moose', 'Elk', 'Caribou', 'Bison', 'Antelope', 'Gazelle', 'Impala', 'Wildebeest', 'Buffalo', 'Yak', 'Camel', 'Llama', 'Alpaca', 'Sheep', 'Goat', 'Pig', 'Cow', 'Horse', 'Donkey', 'Mule', 'Pony', 'Stallion', 'Mare', 'Foal', 'Colt', 'Filly', 'Bull', 'Steer', 'Heifer', 'Ram', 'Ewe', 'Lamb', 'Piglet', 'Pup', 'Kitten', 'Chick', 'Duckling', 'Gosling', 'Cygnets', 'Hatchling', 'Fledgling', 'Joey', 'Pouch', 'Den', 'Lair', 'Nest', 'Burrow', 'Cub', 'Emu', 'Cassowary', 'Kiwi', 'Platypus', 'Echidna', 'Wallaby'];

      // Generate funny name from userId (deterministic)
      function generateFunnyName(userId) {
        const hash = userId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const adjIdx = hash % 100;
        const nounIdx = (hash * 7) % 100;
        return `${adjectives[adjIdx]} ${nouns[nounIdx]}`;
      }

      // Generate colors from userId (deterministic)
      function generateColors(userId) {
        const hash = userId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        
        // Generate background color (lighter, more vibrant)
        const bgHue = hash % 360;
        const bgSaturation = 60 + (hash % 30);
        const bgLightness = 85 + (hash % 10);
        const bgColor = `hsl(${bgHue}, ${bgSaturation}%, ${bgLightness}%)`;
        
        // Generate main/text color (darker, contrasting)
        const mainHue = (bgHue + 180) % 360; // Complementary color
        const mainSaturation = 70 + (hash % 20);
        const mainLightness = 20 + (hash % 15);
        const mainColor = `hsl(${mainHue}, ${mainSaturation}%, ${mainLightness}%)`;
        
        return { bgColor, mainColor };
      }

      // Load or create user data
      async function loadOrCreateUser() {
        const userId = getOrCreateUserId();
        const userRef = doc(db, 'zero-auth', userId);
        
        try {
          const userSnap = await getDoc(userRef);
          
          if (userSnap.exists()) {
            const userData = userSnap.data();
            return {
              id: userId,
              name: userData.name,
              bgColor: userData.bgColor,
              mainColor: userData.mainColor
            };
          } else {
            // Create new user with generated name and colors
            const name = generateFunnyName(userId);
            const colors = generateColors(userId);
            const userData = {
              id: userId,
              name: name,
              bgColor: colors.bgColor,
              mainColor: colors.mainColor,
              created_at: new Date().toISOString(),
              last_seen: new Date().toISOString()
            };
            await setDoc(userRef, userData);
            return userData;
          }
        } catch (error) {
          console.error('Error loading user:', error);
          // Fallback to generated values if Firebase fails
          const name = generateFunnyName(userId);
          const colors = generateColors(userId);
          return {
            id: userId,
            name: name,
            bgColor: colors.bgColor,
            mainColor: colors.mainColor
          };
        }
      }

      // Update user's last_seen
      async function updateLastSeen(userId) {
        const userRef = doc(db, 'zero-auth', userId);
        try {
          await setDoc(userRef, { last_seen: new Date().toISOString() }, { merge: true });
        } catch (error) {
          console.error('Error updating last_seen:', error);
        }
      }

      // Reset identity
      async function resetIdentity() {
        const userId = localStorage.getItem('user_id');
        if (userId) {
          try {
            const userRef = doc(db, 'zero-auth', userId);
            await deleteDoc(userRef);
          } catch (error) {
            console.error('Error deleting user:', error);
          }
        }
        localStorage.removeItem('user_id');
        location.reload();
      }

      // Apply colors to page
      function applyColors(bgColor, mainColor) {
        document.body.style.backgroundColor = bgColor;
        document.body.style.color = mainColor;
      }

      // Initialize app
      (async () => {
        try {
          const userData = await loadOrCreateUser();
          document.getElementById('nameDisplay').textContent = userData.name;
          document.getElementById('uid').textContent = userData.id;
          applyColors(userData.bgColor, userData.mainColor);
          updateLastSeen(userData.id);
        } catch (e) {
          document.getElementById('nameDisplay').textContent = 'Error loading identity';
          document.getElementById('uid').textContent = '';
          console.error(e);
        }
      })();

      document.getElementById('reset').addEventListener('click', async () => {
        if (confirm('Are you sure you want to reset your identity?')) {
          await resetIdentity();
        }
      });
    </script>
  </body>
</html>

